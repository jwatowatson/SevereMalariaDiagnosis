---
title: "Platelet count and plasma PfHRP2 concentration to diagnose severe malaria"
author: "James Watson"
date: "5/10/2021"
output: 
  html_document: 
    toc: yes
    number_sections: yes
    keep_md: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE, cache.comments = FALSE,
                      echo = F, include = TRUE, 
                      fig.width = 8, fig.height = 8,
                      fig.pos = 'H',dev = 'png', dpi = 300)
```


```{r load_data_packages}
library(RColorBrewer)
library(mgcv)
library(lme4)
library(mclust)
library(rstan)
library(gtools)
library(dplyr)
library(reshape2)
library(mvtnorm)
library(LaplacesDemon)

options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)

RUN_STAN=F
source('functions.R')

thresh_highSM = 0.8
thresh_lowSM = 0.2


sessionInfo()
```


# Load dataset 

## Check outliers

```{r}
dat_all=read.csv(file = 'dataset.csv')

writeLines(sprintf('The dataset contains %s patients with measured PfHRP2 and measured platelet counts from %s studies',
                   nrow(dat_all),
                   length(unique(dat_all$study))))
African_studies = c('Kilifi (Kenya)',
                    'Kampala (Uganda)',
                    'FEAST (Uganda)')
writeLines('Patients per study:')
print(table(dat_all$study))
dat_all$study_col = brewer.pal(n = 8, name = 'Dark2')[c(3,4,5,7)][as.numeric(as.factor(dat_all$study))]
mycols = adjustcolor(brewer.pal(n = 10, 'Paired')[c(2,4,6,10)], 
                     alpha.f = .7)
```


## Some data cleaning

```{r}
hist(dat_all$hct, breaks = 50)
# get rid of outlier HCT values
ind = which(dat_all$hct <3 | dat_all$hct>50)
dat_all$hct[ind] = NA
table(!is.na(dat_all$hct))


## PfHRP2 deletions - samples with high parasite count but negative on the ELISA
ind = which(dat_all$hrp2==0 & dat_all$para > 1000)
table(dat_all$study[ind])
hist(log10(dat_all$para[ind]))
writeLines(sprintf('A total of %s samples have zero PfHRP2 but more than 1000 parasites per uL',length(ind)))
dat_all = dat_all[-ind, ]

writeLines(sprintf('After excluding the HRP2 outliers, the dataset contains %s patients with measured PfHRP2 and measured platelet counts',
                   nrow(dat_all)))
```

## Overview of patient characteristics

Results for Table 1 in the paper
```{r}
table(dat_all$study)
table(dat_all$malaria_positive, dat_all$study)

xx=aggregate(age ~ study, dat_all, quantile, probs=c(0.25,.5,.75))
colnames(xx$age)=c('lower','median','upper')
xx$age = round(xx$age,1)
print(xx)

aggregate(hrp2 ~ study, dat_all, length)
aggregate(outcome ~ study, dat_all, function(x) round(100*mean(x),1))
aggregate(platelet ~ study, dat_all, quantile, probs=c(0.25,.5,.75))
aggregate(hrp2 ~ study, dat_all, quantile, probs=c(0.25,.5,.75))
aggregate(wbc ~ study, dat_all, quantile, probs=c(0.25,.5,.75))
ind_pos = which(dat_all$malaria_positive==1)
dat_all$log10_parasites = log10(dat_all$para+50)
xx=aggregate(para ~ study, dat_all[ind_pos, ], 
             quantile, probs=c(0.25,.5,.75))
xx$para = round(xx$para)
print(xx)

table(dat_all$study, dat_all$sickle)

xx = (aggregate(hrp2 ~ as.numeric(dat_all$platelet <= 150), data = dat_all, quantile, probs=c(0.25,.5,.75)))
xx$hrp2 = round(xx$hrp2)
print(xx)
```



Correlation between the platelet count and the PfHRP2 concentration

```{r}
writeLines('African sites: correlation:')
ind_Africa = dat_all$study %in% African_studies
res=cor.test(log10(dat_all$platelet[ind_Africa]),
             log10(dat_all$hrp2+1)[ind_Africa])
res
log10(res$p.value)
round(res$estimate,2)

writeLines('Bangladesh: correlation:')
res=cor.test(log10(dat_all$platelet[!ind_Africa]),
             log10(dat_all$hrp2+1)[!ind_Africa])
res
log10(res$p.value)
round(res$estimate,2)
```

Summary plot of the biomarker data

```{r platelet_hrp2_data}
mycols = rep('black',4)
dat_all$log10_platelet=log10(dat_all$platelet)
ind = which(dat_all$hrp2==0)
dat_all$hrp2[ind] = 10^rnorm(length(ind),0,.1)
dat_all$log10_hrp2 = log10(dat_all$hrp2)
par(las=1, family='serif', mfrow=c(2,2),cex.lab=1.5, cex.axis=1.5)
for(cc in unique(dat_all$study)){
  plot(dat_all$log10_platelet,dat_all$log10_hrp2, 
       panel.first = grid(), xaxt='n', yaxt='n',
       xlab='Platelet count (x1000 per uL)',type='n',
       ylab='PfHRP2 (ng/mL)')
  ind = dat_all$study==cc
  title(paste(cc, ' (n=',sum(ind),')',sep = ''))
  points(dat_all$log10_platelet[ind],
         dat_all$log10_hrp2[ind], pch = 16, 
         col= adjustcolor(dat_all$study_col,.1)[ind])
  points(dat_all$log10_platelet[ind],
         dat_all$log10_hrp2[ind], pch = 1, 
         col= adjustcolor(dat_all$study_col,.5)[ind])
  axis(1, at = log10(c(10, 20,100,1000)),
       labels = c(10, 20,100,1000))
  axis(1, at = log10(seq(20, 90, by =10)), labels = NA)
  axis(1, at = log10(seq(200, 900, by =100)), labels = NA)
  axis(2, at = 0:5, 
       labels = c(1, 10, expression(10^2),expression(10^3), 
                  expression(10^4),expression(10^5)))
}

par(mfrow=c(1,2))
hist(dat_all$log10_hrp2, breaks = 40, main='',xlab='log10 PfHRP2 - all data')
hist(dat_all$log10_platelet, breaks = 40, main='',xlab='log10 platelets - all data')
```


# Basic data exploration: clustering with mclust

mclust is a generic Bayesian clustering algorithm (fits multivariate normals to the data)

We merge all the data into one and fit mclust

```{r mclust}
mclust_cols = RColorBrewer::brewer.pal(8,'Dark2')
par(las=1, family='serif', cex.lab=1.3, cex.axis=1.3)
ind_not_na = !is.na(dat_all$log10_hrp2)&
  !is.na(dat_all$log10_platelet) &
  !is.na(dat_all$log10_parasites)
sum(ind_not_na)
table(dat_all$study[ind_not_na])

X = dat_all[,c('log10_hrp2','log10_platelet','log10_parasites')]

mclust_mods_all = Mclust(data = X[ind_not_na,],
                         G = 3:10)
summary(mclust_mods_all)

# use VVV: ellipsoidal, varying volume, shape, and orientation
mclust_mods_PH = Mclust(data =  X[, 1:2],
                        G = 3:6,
                        initialization = list(hcUse='PCR'),
                        modelNames = 'VVV')

summary(mclust_mods_PH)

plot(dat_all$log10_hrp2, dat_all$log10_platelet,
     col= mclust_cols[mclust_mods_PH$classification],
     panel.first=grid(),
     xlab='Log10 Plasma PfHRP2',
     ylab='Log10 Platelet count (x1000 per uL)')

mclust_mods_ParaH = Mclust(data = X[ind_not_na, c(1,3)],
                           G = 1:8,
                           modelNames = 'VVV')
summary(mclust_mods_ParaH)

plot(X[ind_not_na,1], X[ind_not_na,3],
     col=mclust_mods_ParaH$classification,
     xlab='Plasma PfHRP2',ylab='Parasite count (per uL)')

mclust_mods_ParaP = Mclust(data = X[ind_not_na, c(2,3)],
                           G = 1:8,
                           modelNames = 'VVV')
summary(mclust_mods_ParaP)
plot(X[ind_not_na,2], X[ind_not_na,3],
     col=mclust_mods_ParaP$classification,
     ylab='Parasite count',xlab='Platelet count')

table(dat_all$study, mclust_mods_PH$classification)
```


In conclusion, the distribution of the parasite count is less easily decomposed than that of the platelet count or HRP2 concentration. The HRP2 and platelet count is the only one where the estimated break is not orthogonal to either variable.




# Fitting a mixture model to platelets and HRP2
## Two component mixture - not including FEAST

### Main model

Analysis not including the FEAST study - only severe malaria studies

We convert the platelet counts and HRP2 measurements to log10 scale. The Platelet counts then get multiplied by minus 1: this is so that increasing values correspond to more likely severe malaria. This is because the underlying stan model uses the *ordered* vector type to avoid label switching problems. 

It was not possible to get reasonable fits from this model when we included the parasite density. This most likely results from model mis-specification. The parasite density has a lower discriminatory value for severe malaria as shown by our exploratory analyses (see github). Parasite density is mechanistically related to the \textit{Pf}HRP2 concentration. Pre-referral treatment with antimalarials (which is common in severe malaria referrals) can reduce the admission parasite density substantially (thus a much larger variance in the biomarker values for the true severe malaria subgroup). For these reasons, the main models only used the platelet counts and \textit{Pf}HRP2 concentrations.

```{r setup_stan_model}
# make numeric matrix for stan input
ind_SMstudies = dat_all$study != 'FEAST (Uganda)'
X = dat_all[ind_SMstudies,
            c('log10_platelet',
              'log10_hrp2')]
X$log10_platelet = -X$log10_platelet
site_index_SMstudies = as.numeric(as.factor(dat_all$study[ind_SMstudies]))
table(site_index_SMstudies)

stan_dat_all = 
  list(N = nrow(X),
       y = X,
       Ntest = ncol(X),
       K_sites = max(site_index_SMstudies),
       site = site_index_SMstudies,
       prior_mu = matrix(data = c(-log10(c(200, 100)),
                                  log10(c(500, 2500))),
                         nrow = ncol(X),
                         byrow = T),
       prior_mu_sigma = matrix(data = c(.1,.1,
                                        .1,.1),
                               nrow = ncol(X),
                               byrow = T),
       beta_prior_prev = matrix(data = c(19,1,
                                         14,6,
                                         14,6),
                                nrow = max(site_index_SMstudies),
                                byrow = T),
       nu = 2, df=10)

print(stan_dat_all$N)

stan_dat_all_weak_priors = stan_dat_all
stan_dat_all_weak_priors$beta_prior_prev = 
  matrix(data = c(4,1,
                  2,1,
                  2,1),
         nrow = max(site_index_SMstudies),
         byrow = T)
stan_dat_all_weak_priors$prior_mu_sigma = 
  matrix(data = c(.5,.5,
                  .5,.5),
         nrow = ncol(X),
         byrow = T)

writeLines('Priors on mean biomarker values:\n')
print(stan_dat_all$prior_mu)

writeLines('Priors on standard deviations around biomarker values:\n')
print(stan_dat_all$prior_mu_sigma)

writeLines('Priors on prevalence of SM:\n')
print(stan_dat_all$beta_prior_prev)
```


compile the stan model
```{r compile_stan_model2, include=F}
# compile stan model
lc_mod = stan_model(file = 'Latent_class_continuous_2.stan')
lc_mod_cor = stan_model(file = 'Latent_class_continuous_2_cor.stan')
lc_mod_cor_tdist = stan_model(file = 'Latent_class_continuous_2_tdist_cor.stan')
```


Run the stan models - outputs are stored in Rout
```{r run_stan_models2, include=F}
fname_all = paste0('Rout/', 'mod2_LC_all.stanfit')
if(RUN_STAN | !file.exists(fname_all)){
  out_all = sampling(lc_mod, data=stan_dat_all, thin=4)
  save(out_all, file = fname_all)
} else {
  load(fname_all)
}

## This is the main model
fname_all_cor = paste0('Rout/', 'mod2_LC_all_cor.stanfit')
if(RUN_STAN | !file.exists(fname_all_cor)){
  out_all_cor = sampling(lc_mod_cor, data=stan_dat_all,
                         thin=10,iter=5000,chain=4)
  save(out_all_cor, file = fname_all_cor)
} else {
  load(fname_all_cor)
}

fname_all_cor_WP = paste0('Rout/', 'mod2_LC_all_cor_WkP.stanfit')
if(RUN_STAN | !file.exists(fname_all_cor_WP)){
  out_all_cor_WP = sampling(lc_mod_cor, data=stan_dat_all_weak_priors, thin=4)
  save(out_all_cor_WP, file = fname_all_cor_WP)
} else {
  load(fname_all_cor_WP)
}

fname_all_cor_tdist = paste0('Rout/', 'mod2_LC_all_cor_tdist.stanfit')
if(RUN_STAN | !file.exists(fname_all_cor_tdist)){
  out_all_cor_tdist = sampling(lc_mod_cor_tdist, data=stan_dat_all, thin=4)
  save(out_all_cor_tdist, file = fname_all_cor_tdist)
} else {
  load(fname_all_cor_tdist)
}
```

We check convergence with the traceplots

```{r check_model_fits}
traceplot(out_all,par=c('prev','mu','sigma'))
traceplot(out_all_cor,par=c('prev','mu','sigma'))
traceplot(out_all_cor_WP,par=c('prev','mu','sigma'))
traceplot(out_all_cor_tdist,par=c('prev','mu','sigma'))

thetas_all = extract(out_all)
thetas_all_cor = extract(out_all_cor)
thetas_all_cor_WP = extract(out_all_cor_WP)
thetas_all_cor_tdist = extract(out_all_cor_tdist)

writeLines('prevalence estimates for the three studies: model without correlation:\n')
round(100*colMeans(thetas_all$prev))
writeLines('prevalence estimates for the three studies: model with correlation:\n')
round(100*colMeans(thetas_all_cor$prev))
writeLines('prevalence estimates for the three studies: model with correlation and weak priors:\n')
round(100*colMeans(thetas_all_cor_WP$prev))
writeLines('prevalence estimates for the three studies: model with correlation and t-distributions:\n')
round(100*colMeans(thetas_all_cor_tdist$prev))

mods = list(thetas_all, thetas_all_cor, thetas_all_cor_WP, thetas_all_cor_tdist)
names(mods) = c('thetas_all', 'thetas_all_cor', 'thetas_all_cor_WP',
                'thetas_all_cor_tdist')
writeLines('mean values estimates for the 4 models:\n')
for(i in 1:length(mods)){
  theta = mods[[i]]
  mean_vals = t(apply(theta$mu, 2:3, mean))
  if(i==2){
    mu_pred = mean_vals
    sigma_pred_SM = apply(theta$Sigma[, 1,,], 2:3, mean)
    sigma_pred_notSM = apply(theta$Sigma[, 2,,], 2:3, mean)
  }
  mean_vals[1,] = -mean_vals[1,] 
  mean_vals = round(10^mean_vals)
  colnames(mean_vals) = c('not SM', 'SM')
  rownames(mean_vals) = c('Platelet count','PfHRP2',
                          'Parasite count')[1:nrow(mean_vals)]
  writeLines(names(mods)[i])
  print(mean_vals)
}

save(mu_pred, sigma_pred_SM, sigma_pred_notSM, file = 'SM_pred_model.RData')
writeLines('Standard deviation estimates for the 4 models:\n')
apply(thetas_all$sigma, 2:3, mean)
apply(thetas_all_cor$sigma, 2:3, mean)
apply(thetas_all_cor_WP$sigma, 2:3, mean)
apply(thetas_all_cor_tdist$sigma, 2:3, mean)

writeLines('Correlation in Severe Malaria:\n')
apply(thetas_all_cor$R[,1,,], 2:3, mean)[2,1]
writeLines('Correlation in not Severe Malaria:\n')
apply(thetas_all_cor$R[,2,,], 2:3, mean)[2,1]


# make a prob SM column for the main model (correlation)
dat_all$P_SM1 = NA
dat_all$P_SM1[ind_SMstudies] = colMeans(thetas_all_cor$ps_SM)

dat_all$P_SM1_tdist = NA
dat_all$P_SM1_tdist[ind_SMstudies] = colMeans(thetas_all_cor_tdist$ps_SM)
plot(dat_all$P_SM1, dat_all$P_SM1_tdist)
lines(0:1, 0:1)

ind_SM = colMeans(thetas_all_cor$ps_SM)>thresh_highSM
ind_notSM = colMeans(thetas_all_cor$ps_SM)<thresh_lowSM
sum(ind_SM)
sum(ind_notSM)
```


Classifications under the bivariate normal model

```{r SM_group_classifications_SMonly, echo=F}
n_levels = 11
f=colorRampPalette(colors = RColorBrewer::brewer.pal(name = 'RdYlBu',n = n_levels))
mycuts = cut(x = dat_all$P_SM1, breaks = seq(0,1,by=1/n_levels))
cols_ind = as.numeric(mycuts)
mycols = f(n_levels)

par(las = 1, family='serif',mfrow=c(2,2), cex.lab=1.3,
    cex.axis=1.3)
for(cc in unique(dat_all$study[dat_all$study != 'FEAST (Uganda)'])){
  ind = dat_all$study==cc
  plot(dat_all$log10_platelet,
       dat_all$log10_hrp2,
       type='n',panel.first=grid(), 
       xlab='Platelet count (x1000 per uL)', 
       ylab='PfHRP2 (ng/mL)', xaxt='n', yaxt='n')
  points(dat_all$log10_platelet[ind],
         dat_all$log10_hrp2[ind], pch=1,
         col= 'grey')
  points(dat_all$log10_platelet[ind],
         dat_all$log10_hrp2[ind],  pch=16,
         col= adjustcolor(mycols[cols_ind],.2)[ind])
  if(cc %in% African_studies){
    ind_AS = dat_all$sickle==2
    points(dat_all$log10_platelet[ind&ind_AS],
           dat_all$log10_hrp2[ind&ind_AS],pch=2)
    ind_SS = dat_all$sickle==3
    points(dat_all$log10_platelet[ind&ind_SS],
           dat_all$log10_hrp2[ind&ind_SS],pch=3)
  }
  title(cc)
  axis(1, at = log10(c(10, 20,100,200,1000)),
       labels = c(10, 20,100,200,1000))
  axis(1, at = log10(seq(20, 100, by =10)), 
       labels = NA)
  axis(1, at = log10(seq(200, 1000, by =100)), 
       labels = NA)
  axis(2, at = 0:5, 
       labels = c(1, 10, 
                  expression(10^2),
                  expression(10^3), 
                  expression(10^4),
                  expression(10^5)))
  
}

lgd_ = rep(NA, n_levels)
lgd_[c(1,6,11)] = c(1,0.5,0)
legend('bottomleft',
       legend = lgd_,
       fill = rev(mycols),bty='n',x.intersp =.5,
       border = NA,inset = 0.01,
       y.intersp = 0.5,title = '',
       cex = 1, text.font = 1)

legend('bottomright',pch=2:3, legend = c('HbAS','HbSS'),inset=0.03)
```


Classifications under the bivariate t-distribution model

```{r SM_group_classifications_SMonly_tdist, echo=F}
mycuts = cut(x = dat_all$P_SM1_tdist, breaks = seq(0,1,by=1/n_levels))
cols_ind = as.numeric(mycuts)
mycols = f(n_levels)

par(las = 1, family='serif',mfrow=c(2,2), cex.lab=1.3,
    cex.axis=1.3)
for(cc in unique(dat_all$study[dat_all$study != 'FEAST (Uganda)'])){
  ind = dat_all$study==cc
  plot(dat_all$log10_platelet,
       dat_all$log10_hrp2,
       type='n',panel.first=grid(), 
       xlab='Platelet count (x1000 per uL)', 
       ylab='PfHRP2 (ng/mL)', xaxt='n', yaxt='n')
  points(dat_all$log10_platelet[ind],
         dat_all$log10_hrp2[ind], pch=1, col='grey')
  points(dat_all$log10_platelet[ind],
         dat_all$log10_hrp2[ind],  pch=16,
         col= adjustcolor(mycols[cols_ind],.2)[ind])
  if(cc %in% African_studies){
    ind_AS = dat_all$sickle==2
    points(dat_all$log10_platelet[ind&ind_AS],
           dat_all$log10_hrp2[ind&ind_AS],pch=2)
    ind_SS = dat_all$sickle==3
    points(dat_all$log10_platelet[ind&ind_SS],
           dat_all$log10_hrp2[ind&ind_SS],pch=3)
  }
  title(cc)
  axis(1, at = log10(c(10, 20,100,200,1000)),
       labels = c(10, 20,100,200,1000))
  axis(1, at = log10(seq(20, 100, by =10)), 
       labels = NA)
  axis(1, at = log10(seq(200, 1000, by =100)), 
       labels = NA)
  axis(2, at = 0:5, 
       labels = c(1, 10, 
                  expression(10^2),
                  expression(10^3), 
                  expression(10^4),
                  expression(10^5)))
  
}
lgd_ = rep(NA, n_levels)
lgd_[c(1,6,11)] = c(1,0.5,0)
legend('bottomleft',
       legend = lgd_,
       fill = rev(mycols),bty='n',x.intersp =.5,
       border = NA,inset = 0.01,
       y.intersp = 0.5,title = '',
       cex = 1, text.font = 1)

legend('bottomright',pch=2:3, legend = c('HbAS','HbSS'),inset=0.03)
```


### Platelet counts in not Severe Malaria and Severe Malaria

```{r}
par(las=1, mfrow=c(2,2), family='serif')
ind_rand_notSM = !is.na(dat_all$P_SM1) & (dat_all$P_SM1< 0.5)
hist(dat_all$log10_platelet[ind_rand_notSM],main='not SM',xlab='Log10 platelets',xlim=c(1,3))
hist(dat_all$log10_parasites[ind_rand_notSM],main='not SM',xlab='Log10 parasite density',xlim=c(2,7))

ind_rand_SM = !is.na(dat_all$P_SM1) & (dat_all$P_SM1 > 0.5)
hist(dat_all$log10_platelet[ind_rand_SM],main='SM',xlab='Log10 platelets',xlim=c(1,3))
hist(dat_all$log10_parasites[ind_rand_SM],main='SM',xlab='Log10 parasite density',xlim=c(2,7))
```


### Sensitivity analysis - only African studies

Just use the two severe malaria studies from Africa
```{r setup_stan_model_sensitivityanalysis}
# make numeric matrix for stan input
ind_SMAfrica = dat_all$study != 'FEAST (Uganda)' &
  dat_all$study != 'Bangladesh' 
X = dat_all[ind_SMAfrica,
            c('log10_platelet','log10_hrp2')]
X$log10_platelet = -X$log10_platelet

site_index_SMAfrica = as.numeric(as.factor(dat_all$study[ind_SMAfrica]))
table(site_index_SMAfrica)

stan_dat_all_Af = stan_dat_all
stan_dat_all_Af$N = nrow(X)
stan_dat_all_Af$y = X
stan_dat_all_Af$K_sites = max(site_index_SMAfrica)
stan_dat_all_Af$site = site_index_SMAfrica
stan_dat_all_Af$beta_prior_prev = stan_dat_all$beta_prior_prev[2:3,]
```

Run model and check convergence
```{r fit_stan_model_sensitivityanalysis}
fname_plt_hrp2_Af = paste0('Rout/', 'mod2_LC_plt_hrp2_Af_cor.stanfit')
if(RUN_STAN | !file.exists(fname_plt_hrp2_Af)){
  out_plt_hrp2_Af = sampling(lc_mod_cor, data=stan_dat_all_Af, thin=4)
  save(out_plt_hrp2_Af, file = fname_plt_hrp2_Af)
} else {
  load(fname_plt_hrp2_Af)
}

traceplot(out_plt_hrp2_Af)

thetas_plt_hrp2_Af = extract(out_plt_hrp2_Af)
round(100*colMeans(thetas_plt_hrp2_Af$prev))

writeLines('Mean estimated values across the groups:\n')
mean_vals = t(apply(thetas_plt_hrp2_Af$mu, 2:3, mean))
mean_vals[1,] = -mean_vals[1,] 
mean_vals = round(10^mean_vals)
colnames(mean_vals) = c('not SM', 'SM')
rownames(mean_vals) = c('Platelet count','PfHRP2',
                        'Parasite count')[1:nrow(mean_vals)]
print(mean_vals)
```


### ROC curves for main model fit


```{r roc_curves_mod2, fig.width=9, fig.height=6, echo=F}
cols = brewer.pal(n = 5,name = 'Dark2')[4:5]
par(mfrow=c(2,2),las=1,cex.lab=1.3,cex.axis=1.3,family='serif')
layout(mat = matrix(data = c(1,1,3,3,2,2,3,3),nrow = 2,byrow = T))
roc_final = make_ROC_SM(thetas = thetas_all_cor, 
                        stan_dat = stan_dat_all,
                        xvals = matrix(c(-log10(10),
                                         -log10(1000),1,5),
                                       nrow = 2,byrow = T), 
                        Ntest = 2,
                        SM_comp = 2,
                        cutofftype = c('lower','lower'))
plot((-roc_final$xs[[1]]), 100*roc_final$sens[[1]],
     type='l',panel.first=grid(), lwd=2,col=cols[1],
     xlab = 'Platelet count (x1000 per uL)',lty=3,
     ylab = '%', xlim = log10(c(50, 400)),xaxt='n')
lines((-roc_final$xs[[1]]), 100*roc_final$sp[[1]], 
      lwd=2, lty=2,col=cols[1])
axis(1, at = log10(c(50, 100, 150, 250,400)), labels = c(50, 100, 150, 250,400))
abline(v=log10(150))
legend('bottom',lty=3:2, legend = c('Sensitivity','Specificity'),
       cex = 1.5, lwd=2,inset=0.03)


plot((roc_final$xs[[2]]), 100*roc_final$sens[[2]],
     type='l',panel.first=grid(), lwd=2,col=cols[2],
     xlab = 'Plasma PfHRP2 (ng/mL)',xaxt='n',lty=3,
     ylab = '%', xlim = log10(c(100, 10000)))
lines((roc_final$xs[[2]]), 100*roc_final$sp[[2]],
      col=cols[2], lwd=2,lty=2)
axis(1, at = log10(c(100, 300, 1000,3000,10000)), labels = c(100, 300, 1000,3000,10000))
abline(v=log10(1000))

plot(100*(1-roc_final$sp[[1]]), 100*roc_final$sens[[1]],
     type='l',col=cols[1],
     xlab = 'False positive rate (%)', ylim=c(0,100),
     ylab = 'True positive rate (%)', xlim=c(0,100),
     lwd=3, lty=1, panel.first=grid())
lines(100*(1-roc_final$sp[[2]]), 100*roc_final$sens[[2]],
      col=cols[2], lwd=3)
lines(0:100, 0:100)
legend('bottomright',lty=1, cex=1.5,
       legend = c('Platelet count','Plasma PfHRP2'),
       col=cols,lwd=2,inset=0.03)

out=make_ROC_SM(thetas = thetas_all_cor, 
                stan_dat = stan_dat_all,
                xvals = matrix(c(-log10(150),
                                 -log10(150),3,3),
                               nrow = 2,byrow = T), 
                Ntest = 2,
                SM_comp = 2,
                cutofftype = c('lower','lower'))
writeLines(sprintf('Platelet cutoff of 150,000 per uL has a sensitivity of %s%% and a specificity of %s%%',round(100*out$sens[[1]][1]), round(100*out$sp[[1]][1])))

writeLines(sprintf('PLasma PfHRP2 cutoff of 1000 ng/ml has a sensitivity of %s%% and a specificity of %s%%',round(100*out$sens[[2]][1]), round(100*out$sp[[2]][1])))
```


Empirical ROC curves derived from patient probabilties
```{r roc_curves_mod2_empirical, fig.width=9, fig.height=6, echo=F}
cols = brewer.pal(n = 5,name = 'Dark2')[4:5]
par(mfrow=c(2,2),las=1,cex.lab=1.3,cex.axis=1.3,family='serif')
layout(mat = matrix(data = c(1,1,3,3,2,2,3,3),nrow = 2,byrow = T))

Nsim = 10^4
sim_notSM = rmvn(n = Nsim, 
                 mu = apply(thetas_all_cor$mu[,1,], 2, mean),
                 Sigma = apply(thetas_all_cor$Sigma[,1,,], 2:3, mean))
sim_notSM[,1] = -sim_notSM[,1]
sim_SM = rmvn(n = Nsim, 
              mu = apply(thetas_all_cor$mu[,2,], 2, mean),
              Sigma = apply(thetas_all_cor$Sigma[,2,,], 2:3, mean))
sim_SM[,1] = -sim_SM[,1]


sens_plt = ecdf(sim_SM[,1]); 
xs_plt = seq(log10(10), log10(400),length.out = 100)
sp_plt = ecdf(sim_notSM[,1])

sens_hrp = ecdf(sim_SM[,2]); 
xs_hrp = seq(log10(10), log10(10000),length.out = 100)
sp_hrp = ecdf(sim_notSM[,2])
plot(xs_plt, 100*sens_plt(xs_plt),
     type='l',panel.first=grid(), lwd=2,col=cols[1],
     xlab = 'Platelet count (x1000 per uL)',lty=3,
     ylab = '%', xlim = log10(c(50, 400)),xaxt='n')
lines(xs_plt, 100*(1-sp_plt(xs_plt)), 
      lwd=2, lty=2,col=cols[1])
axis(1, at = log10(c(50, 100, 150, 250,400)), 
     labels = c(50, 100, 150, 250,400))
abline(v=log10(150))
legend('bottom',lty=3:2, 
       legend = c('Sensitivity','Specificity'),
       cex = 1.5, lwd=2,inset=0.03)


plot(xs_hrp, 100*(1-sens_hrp(xs_hrp)),
     type='l',panel.first=grid(), lwd=2,col=cols[2],
     xlab = 'Plasma PfHRP2 (ng/mL)',xaxt='n',lty=3,
     ylab = '%', xlim = log10(c(100, 10000)),ylim=c(0,100))
lines(xs_hrp, 100*(sp_hrp(xs_hrp)),
      col=cols[2], lwd=2,lty=2)
axis(1, at = log10(c(100, 300, 1000,3000,10000)),
     labels = c(100, 300, 1000,3000,10000))
abline(v=log10(1000))

plot(100*(sp_plt(xs_plt)),
     100*sens_plt(xs_plt),
     type='l',col=cols[1],
     xlab = 'False positive rate (%)', ylim=c(0,100),
     ylab = 'True positive rate (%)', xlim=c(0,100),
     lwd=3, lty=1, panel.first=grid())
lines(100*(1-sp_hrp(xs_hrp)), 
      100*(1-sens_hrp(xs_hrp)),
      col=cols[2], lwd=3)
lines(0:100, 0:100)
legend('bottomright',lty=1, cex=1.5,
       legend = c('Platelet count','Plasma PfHRP2'),
       col=cols,lwd=2,inset=0.03)
```

### ROC curves for sensitivity analyses

```{r sensitivity_roc}
par(mfrow=c(2,3),las=1,cex.lab=1.3,cex.axis=1.3,family='serif')

roc_SA1 = make_ROC_SM(thetas = thetas_all_cor_tdist, 
                      stan_dat = stan_dat_all,
                      xvals = matrix(c(-log10(10),
                                       -log10(1000),1,5),
                                     nrow = 2,byrow = T), 
                      Ntest = 2,
                      SM_comp = 2,
                      cutofftype = c('lower','lower'))
plot((-roc_SA1$xs[[1]]), 100*roc_SA1$sens[[1]],
     type='l',panel.first=grid(), lwd=2,col=cols[1],
     xlab = 'Platelet count (x1000 per uL)',lty=3,
     ylab = '%', xlim = log10(c(50, 400)),xaxt='n')
lines((-roc_SA1$xs[[1]]), 100*roc_SA1$sp[[1]], 
      lwd=2, lty=2,col=cols[1])
axis(1, at = log10(c(50, 100, 150, 250,400)), labels = c(50, 100, 150, 250,400))
abline(v=log10(150))
legend('bottom',lty=3:2, legend = c('Sensitivity','Specificity'),
       cex = 1.5, lwd=2,inset=0.03)


plot((roc_SA1$xs[[2]]), 100*roc_SA1$sens[[2]],
     type='l',panel.first=grid(), lwd=2,col=cols[2],
     xlab = 'Plasma PfHRP2 (ng/mL)',xaxt='n',lty=3,
     ylab = '%', xlim = log10(c(100, 10000)))
lines((roc_SA1$xs[[2]]), 100*roc_SA1$sp[[2]],
      col=cols[2], lwd=2,lty=2)
axis(1, at = log10(c(100, 300, 1000,3000,10000)), labels = c(100, 300, 1000,3000,10000))
abline(v=log10(1000))
plot(100*(1-roc_SA1$sp[[1]]), 100*roc_SA1$sens[[1]],
     type='l',col=cols[1],
     xlab = 'False positive rate (%)', ylim=c(0,100),
     ylab = 'True positive rate (%)', xlim=c(0,100),
     lwd=3, lty=1, panel.first=grid())
lines(100*(1-roc_SA1$sp[[2]]), 100*roc_SA1$sens[[2]],
      col=cols[2], lwd=3)
lines(0:100, 0:100)
legend('bottomright',lty=1, cex=1.5,
       legend = c('Platelet count','Plasma PfHRP2'),
       col=cols,lwd=2,inset=0.03)

roc_SA2 = make_ROC_SM(thetas = thetas_all_cor_WP, 
                      stan_dat = stan_dat_all,
                      xvals = matrix(c(-log10(10),
                                       -log10(1000),1,5),
                                     nrow = 2,byrow = T), 
                      Ntest = 2,
                      SM_comp = 2,
                      cutofftype = c('lower','lower'))

plot((-roc_SA2$xs[[1]]), 100*roc_SA2$sens[[1]],
     type='l',panel.first=grid(), lwd=2,col=cols[1],
     xlab = 'Platelet count (x1000 per uL)',lty=3,
     ylab = '%', xlim = log10(c(50, 400)),xaxt='n')
lines((-roc_SA2$xs[[1]]), 100*roc_SA2$sp[[1]], 
      lwd=2, lty=2,col=cols[1])
axis(1, at = log10(c(50, 100, 150, 250,400)), labels = c(50, 100, 150, 250,400))
abline(v=log10(150))
legend('bottom',lty=3:2, legend = c('Sensitivity','Specificity'),
       cex = 1.5, lwd=2,inset=0.03)


plot((roc_SA2$xs[[2]]), 100*roc_SA2$sens[[2]],
     type='l',panel.first=grid(), lwd=2,col=cols[2],
     xlab = 'Plasma PfHRP2 (ng/mL)',xaxt='n',lty=3,
     ylab = '%', xlim = log10(c(100, 10000)))
lines((roc_SA2$xs[[2]]), 100*roc_SA2$sp[[2]],
      col=cols[2], lwd=2,lty=2)
axis(1, at = log10(c(100, 300, 1000,3000,10000)), labels = c(100, 300, 1000,3000,10000))
abline(v=log10(1000))
plot(100*(1-roc_SA2$sp[[1]]), 100*roc_SA2$sens[[1]],
     type='l',col=cols[1],
     xlab = 'False positive rate (%)', ylim=c(0,100),
     ylab = 'True positive rate (%)', xlim=c(0,100),
     lwd=3, lty=1, panel.first=grid())
lines(100*(1-roc_SA2$sp[[2]]), 100*roc_SA2$sens[[2]],
      col=cols[2], lwd=3)
lines(0:100, 0:100)
legend('bottomright',lty=1, cex=1.5,
       legend = c('Platelet count','Plasma PfHRP2'),
       col=cols,lwd=2,inset=0.03)
```



## Three component mixture - including FEAST


This does not fit when we add parasite counts. So we are only using two biomarkers


```{r compile_stan_model3, include=F}
lc3_mod = stan_model(file = 'Latent_class_continuous_3_cor.stan')
```



```{r run_stan_model3}
# make numeric matrix for stan input
X = dat_all[, c('log10_platelet','log10_hrp2')]
X$log10_platelet = -X$log10_platelet
site_index_all_studies = as.numeric(as.factor(dat_all$study))
table(site_index_all_studies)
stan_dat_final = 
  list(N = nrow(X),
       y = X,
       Ntest = ncol(X),
       K_sites = max(site_index_all_studies),
       site = site_index_all_studies,
       prior_mu = matrix(data = c(-log10(c(300, 200, 100)),
                                  log10(c(1, 500, 2500))),
                         nrow = ncol(X),
                         byrow = T),
       prior_mu_sigma = matrix(data = c(.1,.1,.1,
                                        .2,.2,.2),
                               nrow = ncol(X),
                               byrow = T),
       prior_sigma_vals = matrix(data = c(.1,.1,
                                          .1,.1,
                                          .1,.1),
                                 nrow = 3,
                                 byrow = T),
       dirichlet_prior_prev = matrix(data = c(.1,1,19,
                                              1,6,14,
                                              1,6,14,
                                              3,3,3),
                                     nrow = max(site_index_all_studies),
                                     byrow = T),
       nu = 10, df=10)
writeLines('Priors on mean biomarker values:\n')
print(stan_dat_final$prior_mu)

writeLines('Priors on standard deviations around biomarker values:\n')
print(stan_dat_final$prior_mu_sigma)

writeLines('Priors on prevalence of SM:\n')
print(stan_dat_final$dirichlet_prior_prev)
```

Run models:
```{r, run_mod3}
fname_final = paste0('Rout/', 'mod3_LC_cor_final.stanfit')
if(RUN_STAN | !file.exists(fname_final)){
  out_final = sampling(lc3_mod, data = stan_dat_final, iter=2000,thin=4)
  save(out_final, file = fname_final)
} else {
  load(fname_final)
}
```


```{r summary_fit3}
traceplot(out_final, par=c('mu'))
thetas_final = extract(out_final)

writeLines('Estimated prevalences across the 4 studies:\n')
xx=round(100*apply(thetas_final$prev_comp, 2:3, 
                   quantile, probs=c(.025, 0.5, 0.975)),1)
colnames(xx) = levels(as.factor(dat_all$study))
xx[, ,3]

mean_vals = t(apply(thetas_final$mu, 2:3, mean))
mean_vals[1,] = -mean_vals[1,] 
sigma_vals = t(apply(thetas_final$sigma, 2:3, mean))

mean_vals_exp = 10^mean_vals
colnames(mean_vals_exp) = c('not SM', 'not SM', 'SM')
rownames(mean_vals_exp) = c('Platelet count','PfHRP2')
print(round(mean_vals_exp))


c_upper=round(10^(mean_vals + 1.96*sigma_vals))
c_lower=round(10^(mean_vals - 1.96*sigma_vals))



writeLines(sprintf('In SM the 95%% pred interval for the platelet count is %s to %s with a mean of %s',c_lower[1,3],c_upper[1,3],round(mean_vals_exp[1,3]) ))

writeLines(sprintf('In SM the 95%% pred interval for the PfHRP2 concentration is %s to %s with a mean of %s',c_lower[2,3],c_upper[2,3],round(mean_vals_exp[2,3])))


writeLines(sprintf('In not SM the 95%% pred interval for the platelet count is %s to %s with a mean of %s',c_lower[1,2],c_upper[1,2],round(mean_vals_exp[1,2]) ))

writeLines(sprintf('In not SM the 95%% pred interval for the PfHRP2 concentration is %s to %s with a mean of %s',c_lower[2,2],c_upper[2,2],round(mean_vals_exp[2,2])))
```




Make a P(SM) variable for subsequent analysis (continuous) and a discrete classification based on a cutoff of 0.5
```{r}
dat_all$P_SM = colMeans(thetas_final$ps_SM)
dat_all$SM = as.numeric(dat_all$P_SM>0.5)
hist(dat_all$P_SM, breaks = 20,main='Final model', xlab='P(SM)')
plot(dat_all$P_SM1, dat_all$P_SM,
     xlab="Model probabilities excluding FEAST", 
     ylab="Model probabilities including FEAST")
```



# Downstream analyses

## Severe malaria probability and subphenotypes

Relationship with the two main subphenotypes, cerebral malaria and severe malaria anaemia
```{r, echo=F}
writeLines('False diagnosis rate by coma status and by study:')
print(aggregate(SM ~ coma + study, data = dat_all, mean))

writeLines('True diagnosis rate by severe anaemia status (<15% haematocrit) and by study:')
dat_all$SMA = as.numeric(dat_all$hct<=15)
print(aggregate(SM ~ SMA + study, data = dat_all,mean))
```


Main model fits - three component model
```{r SM_group_classifications, echo=F}
par(las = 1, family='serif',mfrow=c(2,2), cex.lab=1.3,
    cex.axis=1.3)
n_levels = 11
f=colorRampPalette(colors = RColorBrewer::brewer.pal(name = 'RdYlBu',n = n_levels))
mycuts = cut(x = dat_all$P_SM, breaks = seq(0,1,by=1/n_levels))
cols_ind = as.numeric(mycuts)
mycols = f(n_levels)
X$log10_platelet = -X$log10_platelet

for(cc in unique(dat_all$study)){
  ind = dat_all$study==cc
  plot(X, type='n',
       panel.first=grid(), 
       xlab='Platelet count (x1000 per uL)', 
       ylab='PfHRP2 (ng/mL)', xaxt='n', yaxt='n')
  points(X[ind, ],  pch=1,col= 'grey')
  points(X[ind, ],  pch=16,
         col= adjustcolor(mycols[cols_ind],.3)[ind])
  if(cc %in% African_studies){
    ind_AS = dat_all$sickle==2
    points(X[ind&ind_AS, ],pch=2)
    ind_SS = dat_all$sickle==3
    points(X[ind&ind_SS, ],pch=3)
  }
  title(cc)
  axis(1, at = log10(c(10, 20,100,200,1000)),
       labels = c(10, 20,100,200,1000))
  axis(1, at = log10(seq(20, 100, by =10)), 
       labels = NA)
  axis(1, at = log10(seq(200, 1000, by =100)), 
       labels = NA)
  axis(2, at = 0:5, 
       labels = c(1, 10, 
                  expression(10^2),
                  expression(10^3), 
                  expression(10^4),
                  expression(10^5)))
  
}
table(sickle=dat_all$sickle, 
      class=dat_all$SM, 
      study=dat_all$study)

lgd_ = rep(NA, n_levels)
lgd_[c(1,6,11)] = c(1,0.5,0)
legend('bottomleft',
       legend = lgd_,
       fill = rev(mycols),bty='n',x.intersp =.5,
       border = NA,inset = 0.01,
       y.intersp = 0.5,title = '',
       cex = 1, text.font = 1)

legend('bottomright',pch=2:3, legend = c('HbAS','HbSS'),inset=0.03)
```

## Parasite densities

```{r parasite_densities, echo=F}
### Parasite counts
ind_mal = dat_all$malaria_positive==1
par(las = 1, family='serif',mfrow=c(2,2), cex.lab=1.3, cex.axis=1.3)
for(cc in unique(dat_all$study)){
  ind = dat_all$study==cc
  set.seed(7475)
  myxs=dat_all$P_SM[ind & ind_mal]
  myys=log10(dat_all$para+10^1.7)[ind & ind_mal]
  plot(myxs,myys, panel.first=grid(), ylim =c(1.5,6.5),
       pch=1, xlim=c(0,1),
       col = adjustcolor('black',.4),
       xlab='Prob(Severe Malaria)', 
       ylab='Parasite density per uL',yaxt='n')
  points(myxs,myys,pch=16,col = adjustcolor('black',.1))
  # axis(1, at=1:3,labels = c('A','B','C'), tick = F)
  axis(2, at = 2:6, 
       labels = c(expression(10^2),
                  expression(10^3), 
                  expression(10^4),
                  expression(10^5),
                  expression(10^6)))
  mod=gam(myys ~ s(myxs,k=3),
          data=data.frame(myys=myys,myxs=myxs))
  pxs=seq(0,1,length.out = 100)
  lines(pxs,predict(mod, data.frame(myxs=pxs)),lwd=3)
  title(cc)
  
  print(cc)
  print(10^predict(mod, data.frame(myxs=1))/ 10^predict(mod, data.frame(myxs=0)))
}


mod_all_para = lm(log10_parasites ~ P_SM + study,
                  data=dat_all[ind_mal, ])
summary(mod_all_para)$coefficients

xx = summary(mod_all_para)$coefficients['P_SM',1:2]
writeLines('The expected fold increase in parasite density between true severe malaria (P_SM=1) and not severe malaria (P_SM=0) is:\n')
round(10^(xx[1] + c(-1.96, 0, 1.96)*xx[2]),1)
```



## Admission haematocrits


```{r haematocrits, echo=F}
par(las = 1, family='serif',mfrow=c(2,2), cex.lab=1.3, cex.axis=1.3)
for(cc in unique(dat_all$study)){
  ind = dat_all$study==cc
  set.seed(7475)
  myxs=(dat_all$P_SM)[ind]
  myys=jitter(dat_all$hct[ind], amount = .1)
  plot(myxs,myys,panel.first=grid(), 
       ylim = range(dat_all$hct,na.rm = T),
       pch=1, xlim=c(0,1),
       col = adjustcolor('black',.4),
       xlab='Prob(Severe Malaria)',
       ylab='Haematocrit (%)')
  points(myxs,myys,pch=16,col = adjustcolor('black',.1))
  mod=gam(myys ~ s(myxs,k=3),
          data=data.frame(myys=myys,myxs=myxs))
  pxs=seq(0,1,length.out = 100)
  lines(pxs,predict(mod, data.frame(myxs=pxs)),lwd=3)
  title(cc)
}
hct_subgroups = aggregate(hct ~ SM + study, 
                          dat_all, median)
print(hct_subgroups)

# Severe anaemia
SA_subgroups = aggregate(hct ~ SM + study, 
                         dat_all, function(x) round(100*mean(x<15),1))
print(SA_subgroups)

ind_SM = dat_all$P_SM > thresh_highSM
ind_notSM = dat_all$P_SM < thresh_lowSM
par(mfcol=c(2,3))
for(cc in c("FEAST (Uganda)","Kampala (Uganda)", "Kilifi (Kenya)")){
  ind = dat_all$study==cc
  
  hist(dat_all$hct[ind_SM&ind], breaks = seq(0,50, by=1),
       xlab='Haematocrit (%)', ylab='Number of patients',
       main = paste0(cc,': ', 'P(SM)>0.8'),
       panel.first=grid())
  abline(v=median(dat_all$hct[ind_SM&ind],na.rm=T),lwd=2, col='red')
  print(median(dat_all$hct[ind_SM&ind],na.rm=T))
  hist(dat_all$hct[ind_notSM&ind], breaks = seq(0,50, by=1),
       xlab='Haematocrit (%)', ylab='Number of patients',
       main = paste0(cc,': ', 'P(SM)<0.2'),
       panel.first=grid())
  abline(v=median(dat_all$hct[ind_notSM&ind],na.rm=T),lwd=2, col='red')
  print(median(dat_all$hct[ind_notSM&ind],na.rm=T))
}

```


## Mortality


P(Severe malaria) and mortality
```{r mortality, echo=F}
par(las = 1, family='serif',mfrow=c(2,2), cex.lab=1.3, cex.axis=1.3)
for(cc in unique(dat_all$study)){
  ind = dat_all$study==cc
  set.seed(7475)
  xs = seq(0,1,length.out = 100)
  mod=glm(outcome ~ P_SM, family='binomial', data = dat_all[ind, ])
  print(summary(mod))
  preds=predict(mod,newdata = data.frame(P_SM=xs),se.fit = T)
  plot(xs,100*inv.logit(preds$fit),panel.first=grid(), 
       type='l',lwd=2,  col = adjustcolor('black',.4),
       xlab='Prob(Severe Malaria)',
       ylim = range(100*inv.logit(c(preds$fit+1.96*preds$se.fit,
                                    rev(preds$fit-1.96*preds$se.fit)))),
       ylab='Probability of death (%)')
  polygon(x = c(xs, rev(xs)), 
          y = 100*inv.logit(c(preds$fit+1.96*preds$se.fit,
                              rev(preds$fit-1.96*preds$se.fit))),
          col=adjustcolor('grey', .3), border = NA)
  title(cc)
}
```


Summary of lab values by inferred subgroup
```{r, echo=F}
age_subgroups = aggregate(age ~ SM + study, 
                          dat_all, function(x) round(median(x),1))
print(age_subgroups)

para_subgroups = aggregate(log10_parasites ~ SM + study, 
                           dat_all, function(x) round(mean(x),1))
para_subgroups$log10_parasites=round(10^para_subgroups$log10_parasites)
print(para_subgroups)

dat_all$log10_wbc = log10(dat_all$wbc)
wbc_subgroups = aggregate(log10_wbc ~ SM + study, 
                          dat_all, function(x) round(mean(x),1))
wbc_subgroups$log10_wbc=round(10^wbc_subgroups$log10_wbc)
print(wbc_subgroups)

hbb_subgroups = aggregate(sickle ~ SM + study, 
                          dat_all, table)
print(hbb_subgroups)

death_subgroups = aggregate(outcome ~ SM + study, 
                            dat_all, function(x) round(100*mean(x),1))
print(death_subgroups)
```

## Total white blood cell counts


```{r wbcs, echo=F}
par(las = 1, family='serif',mfrow=c(2,2), cex.lab=1.3, cex.axis=1.3)
for(cc in unique(dat_all$study)){
  ind = dat_all$study==cc
  set.seed(7475)
  myxs=(dat_all$P_SM)[ind]
  myys=log10(dat_all$wbc[ind])
  plot(myxs,myys,panel.first=grid(), 
       ylim = range(log10(dat_all$wbc),na.rm = T),
       pch=1, xlim=c(0,1), yaxt='n',
       col = adjustcolor('black',.4),
       xlab='Prob(Severe Malaria)',
       ylab='White blood cell count (x1000 per uL)')
  axis(2, at = log10(c(1,3,10,30,100)), labels = c(1,3,10,30,100))
  points(myxs,myys,pch=16,col = adjustcolor('black',.1))
  mod=gam(myys ~ s(myxs,k=3),
          data=data.frame(myys=myys,myxs=myxs))
  pxs=seq(0,1,length.out = 100)
  lines(pxs,predict(mod, data.frame(myxs=pxs)),lwd=3)
  title(cc)
}

mod_wbc = lm(log10_wbc ~ study + SM + age, data = dat_all)
xx=summary(mod_wbc)
xx$coefficients
10^(-xx$coefficients['SM',1])

ind_mal = dat_all$malaria_positive==1
writeLines('WBC > 15,000 for SM versus not SM:\n')
mod_wbc2 = gam(as.numeric(wbc>15) ~ study + SM + s(age,k=3),
               family='binomial',
               data = dat_all[ind_mal, ])
xx=summary(mod_wbc2)
print(xx)
writeLines('Odds-ratio:\n')
round(exp(xx$p.coeff['SM'] + c(-1,0,1)*xx$se['SM']),2)

table(dat_all$study, dat_all$wbc > 15)

```

## Bacteraemia

Relationship between the blood culture data and the probability of severe malaria.
We also look at whether WBC values predict positive blood culture

```{r blood_cultures, echo=F}
writeLines('Blood culture positive numbers by study:\n')
table(dat_all$SM, dat_all$BS, dat_all$study)
ind_FEAST = dat_all$study=='FEAST (Uganda)'
ind_Kenya = dat_all$study=='Kilifi (Kenya)'
ind_mal = dat_all$malaria_positive==1

writeLines('Blood culture positive numbers in FEAST (all):\n')
table(dat_all$BS[ind_FEAST], useNA = 'ifany')
writeLines('Blood culture positive numbers in FEAST (malaria RDT+):\n')
table(dat_all$BS[ind_FEAST&ind_mal], useNA = 'ifany')
writeLines('Blood culture positive numbers in Kenya:\n')
table(dat_all$BS[ind_Kenya], useNA = 'ifany')

mean(!is.na(dat_all$BS[ind_FEAST]))

writeLines('main model for bacteraemia:\n')
mod = glm(BS ~ SM + study, family='binomial',
          data = dat_all[ind_mal, ])
summary(mod)


summary(glm(BS ~ SM, family='binomial',
            data = dat_all[ind_FEAST&ind_mal,])
)$coefficients
summary(glm(BS ~ SM, family='binomial',
            data = dat_all[ind_Kenya,])
)$coefficients

xx=summary(mod)$coefficients
writeLines('Odds ratio for blood culture+ in SM versus not SM:\n')
round(exp(xx[2,1] + c(-1,0,1)*1.96* xx[2,2]),2)

summary(glm(BS ~ log10_wbc + study, family='binomial',
            data = dat_all[ind_mal, ]))

```

# Validation using sickle trait

```{r sickle, echo=F}
ind = dat_all$sickle%in% 1:2
mod=glm(SM ~ sickle + study, family='binomial',
        data.frame(SM=dat_all$SM[ind],
                   sickle=as.numeric(dat_all$sickle==2)[ind],
                   study = as.factor(dat_all$study)[ind]))
summary(mod)
xx=summary(mod)$coefficients

writeLines('Odds ratio for SM for HbAS versus HbAA:\n')
round(exp(xx['sickle','Estimate']+(c(-1,0,1)*1.96*xx['sickle','Std. Error'])),2)

for(ss in African_studies){
  ind = dat_all$study==ss & dat_all$sickle%in% 1:2
  mod=glm(SM ~ sickle, family='binomial',
          data.frame(SM=dat_all$SM[ind],
                     sickle=as.numeric(dat_all$sickle==2)[ind]))
  xx=summary(mod)$coefficients
  print(ss)
  print(round(exp(xx['sickle','Estimate']+(c(-1,0,1)*1.96*xx['sickle','Std. Error'])),2))
}

ind = dat_all$sickle%in% c(1,3)
table(dat_all$SM, dat_all$sickle, dat_all$study)
mod=glm(SM ~ sickle + study, family='binomial',
        data.frame(SM=dat_all$SM[ind],
                   sickle=as.numeric(dat_all$sickle==3)[ind],
                   study = as.factor(dat_all$study)[ind]))
summary(mod)
xx=summary(mod)$coefficients
writeLines('Odds ratio for SM for HbSS versus HbAA:\n')
round(exp(xx['sickle','Estimate']+(c(-1,0,1)*1.96*xx['sickle','Std. Error'])),2)


for(ss in African_studies){
  ind = dat_all$study==ss & dat_all$sickle%in% c(1,3)
  mod=glm(SM ~ sickle, family='binomial',
          data.frame(SM=dat_all$SM[ind],
                     sickle=as.numeric(dat_all$sickle==3)[ind]))
  xx=summary(mod)$coefficients
  print(ss)
  print(round(exp(xx['sickle','Estimate']+(c(-1,0,1)*1.96*xx['sickle','Std. Error'])),2))
}

# Additive model
mod=glm(SM ~ sickle + study, family='binomial',
        data.frame(SM=dat_all$SM,
                   sickle=dat_all$sickle,
                   study = as.factor(dat_all$study)))
summary(mod)

xx=summary(mod)$coefficients
writeLines('Odds ratio for SM for additional S allele (additive model):\n')
round(exp(xx['sickle','Estimate']+(c(-1,0,1)*1.96*xx['sickle','Std. Error'])),2)
```




# Compare with previously published probabilities

```{r comparison_old_model}
model1_probs = read.csv(file = 'Kilifi_Model1_Probabilities.csv')
model1_probs = model1_probs %>% arrange(sample_code) %>% filter(sample_code %in% dat_all$IDs)
dat_Kilifi = dat_all %>% filter(study=='Kilifi (Kenya)')%>%arrange(IDs)

par(las=1, family='serif', cex.lab=1.3, cex.axis=1.3)
plot(model1_probs$P_SM1, dat_Kilifi$P_SM,
     xlab='Prob(Severe Malaria): platelet/white count model',
     ylab='Prob(Severe Malaria): platelet/PfHRP2 model',
     panel.first=grid(), main = 'Kilifi (Kenya)')
abline(lm(dat_Kilifi$P_SM~model1_probs$P_SM1), col='red',lwd=3)
hist(model1_probs$P_SM1 - dat_Kilifi$P_SM)


cor.test(model1_probs$P_SM1, dat_Kilifi$P_SM)
```





Save output
```{r}
dat_kemri = dat_all[dat_all$study=='Kilifi (Kenya)', ]
write.csv(dat_kemri, file = 'kemri_PSM.csv')
```



# Optimal combination of thresholds


```{r}
x1 = seq(100, 200, by=1)
x2 = seq(100, 2000, by=5)
my_thresh=expand.grid(plt_thresh = x1, 
                      hrp2_thresh = x2)
my_thresh$x1_trans = -log10(my_thresh$plt_thresh)
my_thresh$x2_trans = log10(my_thresh$hrp2_thresh)
my_thresh$FP = my_thresh$TP = NA

# simulate data from the models
Nsim = 10^5
sim_notSM = rmvn(n = Nsim, 
                 mu = apply(thetas_all_cor$mu[,1,], 2, mean),
                 Sigma = apply(thetas_all_cor$Sigma[,1,,], 2:3, mean))
sim_SM = rmvn(n = Nsim, 
              mu = apply(thetas_all_cor$mu[,2,], 2, mean),
              Sigma = apply(thetas_all_cor$Sigma[,2,,], 2:3, mean))
dat_sim = data.frame(rbind(sim_SM, sim_notSM))
dat_sim$SM = c(rep(1,Nsim),rep(0,Nsim))
dat_sim = dat_sim[sample(1:(2*Nsim), size = 2*Nsim, replace = F),]

ind_SM_sim = dat_sim$SM==1

for(k in 1:nrow(my_thresh)){
  my_thresh$TP[k] = mean(dat_sim$X1[ind_SM_sim]>my_thresh$x1_trans[k] &
                           dat_sim$X2[ind_SM_sim]>my_thresh$x2_trans[k])
  my_thresh$FP[k] = mean(dat_sim$X1[!ind_SM_sim]>my_thresh$x1_trans[k] &
                           dat_sim$X2[!ind_SM_sim]>my_thresh$x2_trans[k])
}
my_thresh$ProbSM = round(100*0.6*my_thresh$TP/(0.6*my_thresh$TP+ 0.4*my_thresh$FP))
my_thresh$FP = round(100*my_thresh$FP, 2)
my_thresh$TP = round(100*my_thresh$TP, 2)


xs = unique(my_thresh$FP)
ys = array(dim = length(xs))
for(i in 1:length(xs)){
  ind = my_thresh$FP == xs[i]
  ys[i] = max(my_thresh$TP[ind])
}

my_fp = 10
my_tp = 75
```


Plot results
```{r optimal_combination}
f=smooth.spline(x = xs, y = ys,df = 5)
par(las=1, family='serif', cex.lab=1.3, cex.axis=1.3,mfrow=c(2,2))
z_FP = dcast(data = my_thresh, formula = hrp2_thresh~plt_thresh, 
             value.var='FP')
range(z_FP[, -1])

z_TP = dcast(data = my_thresh, formula = hrp2_thresh~plt_thresh, value.var='TP')
range(z_TP[, -1])

PPV_TP = dcast(data = my_thresh, 
               formula = hrp2_thresh~plt_thresh,
               value.var='ProbSM')
range(PPV_TP[, -1])

image(y = x1, x=x2, z=as.matrix(z_FP[, -1]),
      breaks = seq(0,35,length.out = 15),
      main='False positive (%)',yaxt='n',
      col=hcl.colors(14, "YlGn", rev = TRUE),
      xlab='PfHRP2 (ng/mL)',
      ylab='Platelet count (x1000 per uL)')
axis(2, at = c(100,150,200))
grid()
abline(v=1000, h=150,lty=2)


image(y = x1, x=x2, z=as.matrix(z_TP[, -1]),
      breaks = seq(48,92,length.out = 15),panel.first=grid(),
      main='True positive (%)',yaxt='n',
      col=hcl.colors(14, "Blue-Red 3", rev = TRUE),
      xlab='PfHRP2 (ng/mL)',ylab='Platelet count (x1000 per uL)')
axis(2, at = c(100,150,200))
grid()
abline(v=1000, h=150,lty=2)



image(y = x1, x=x2, z=as.matrix(PPV_TP[, -1]),
      breaks = seq(80,100,length.out = 15),
      panel.first=grid(),
      main='Positive predictive value (60% prevalence)',
      yaxt='n',
      col= hcl.colors(14, "Green-Brown", rev = F),
      xlab='PfHRP2 (ng/mL)',ylab='Platelet count (x1000 per uL)')
axis(2, at = c(100,150,200))
grid()
abline(v=1000, h=150,lty=2)


ind = my_thresh$FP < my_fp & my_thresh$TP > my_tp

writeLines(sprintf('There are %s combinations that have a true positive rate greater than %s and a false positive rate less than %s', 
                   sum(ind), my_tp, my_fp))
print(my_thresh[my_thresh$plt_thresh==150&my_thresh$hrp2_thresh==1000, ])

## Legend plot
plot(NA,NA,xlim=0:1,ylim=0:1,yaxt='n',xaxt='n',ylab='',xlab='',bty='n')

lgd_ = rep(NA, 15)
lgd_[c(1,8,15)] = c(0,18,35)
legend('left',title = 'FP (%)\n',
       legend = lgd_,
       fill = hcl.colors(15, "YlGn", rev = TRUE),
       bty='n',x.intersp =.5,
       border = NA,inset = 0.01,
       y.intersp = 0.5,
       cex = 1, text.font = 1)

lgd_ = rep(NA, 15)
lgd_[c(1,8,15)] = c(92,71,50)
legend('center',title = 'TP (%)\n',
       legend = lgd_,
       fill = hcl.colors(15, "Blue-Red 3", rev = F),
       bty='n',x.intersp =.5,
       border = NA,inset = 0.01,
       y.intersp = 0.5,
       cex = 1, text.font = 1)


lgd_ = rep(NA, 15)
lgd_[c(1,8,15)] = c(97,89,80)
legend('right',title = 'Prob(SM)\n',
       legend = lgd_,
       fill = hcl.colors(15, "Green-Brown", rev = T),
       bty='n',x.intersp =.5,
       border = NA,inset = 0.01,
       y.intersp = 0.5,
       cex = 1, text.font = 1)
```


# Predicting Severe Malaria using HRP2, parasite counts and HCT

Slightly random: predict SM status using HRP2 and HCT
```{r}
# ind_SM = dat_all$P_SM > .9
# plot(dat_all$hct[ind_SM], log10(dat_all$hrp2[ind_SM]))

dat_all$study = as.factor(dat_all$study)
modSM = gam(SM ~ s(hct,k=3) + s(log10(hrp2+1),k=3)+
              s(log10_parasites,k=3)
            + s(study, bs='re'),
            family='binomial', data=dat_all)
summary(modSM)
save(modSM, file = 'SMmodel')
```

